name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        package: [core, example-console, example-eda, example-express, example-nextjs-sse]

    steps:
      - uses: actions/checkout@v4

       - uses: actions/setup-node@v4
         with:
           node-version: '18'
           cache: 'npm'

       - name: Setup Next.js cache
         if: matrix.package == 'example-nextjs-sse'
         uses: actions/cache@v3
         with:
           path: packages/example-nextjs-sse/.next/cache
           key: ${{ runner.os }}-nextjs-${{ hashFiles('packages/example-nextjs-sse/package-lock.json') }}
           restore-keys: |
             ${{ runner.os }}-nextjs-

       - name: Install dependencies
         run: npm ci

       - name: Install sqlite3 (for core tests)
         if: matrix.package == 'core'
         run: npm install sqlite3

       - name: Lint
         run: cd packages/${{ matrix.package }} && npm run lint

      - name: Type Check
        run: cd packages/${{ matrix.package }} && npm run typecheck

      - name: Build
        run: cd packages/${{ matrix.package }} && npm run build

      - name: Test
        run: cd packages/${{ matrix.package }} && npm test